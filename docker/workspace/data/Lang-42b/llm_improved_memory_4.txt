    public void escape(Writer writer, String str) throws IOException {
        int len = str.length();
        StringBuilder sb = new StringBuilder();
        
        for (int i = 0; i < len; i++) {
            int c = Character.codePointAt(str, i); 
            String entityName = this.entityName(c);
            
            if (entityName == null) {
                if (c >= 0x010000 && i < len - 1) {
                    sb.append("&#");
                    sb.append(Integer.toString(c, 10));
                    sb.append(';');
                    i++;
                } else if (c > 0x7F) { 
                    sb.append("&#");
                    sb.append(Integer.toString(c, 10));
                    sb.append(';');
                } else {
                    sb.appendCodePoint(c);
                }
            } else {
                sb.append('&');
                sb.append(entityName);
                sb.append(';');
            }
        }
        
        writer.write(sb.toString());
    }