    private void popStackToClose(Token.EndTag endTag) {
        String elName = endTag.normalName();
        Element firstFound = null;

        int pos = stack.size() - 1;
        while (pos >= 0) {
            Element next = stack.get(pos);
            if (next.normalName().equals(elName)) {
                firstFound = next;
                break;
            }
            pos--;
        }
        if (firstFound == null)
            return; // not found, skip

        while (stack.size() > pos + 1) {
            stack.remove(stack.size() - 1);
        }
    }