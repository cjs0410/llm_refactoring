    private void popStackToClose(Token.EndTag endTag) {
        String elName = endTag.normalName();
        Element firstFound = null;

        for (int pos = stack.size() - 1; pos >= 0; pos--) {
            Element next = stack.get(pos);
            if (next.nodeName().equals(elName)) {
                firstFound = next;
                break;
            }
        }

        if (firstFound != null) {
            List<Element> elementsToRemove = new ArrayList<>(stack.subList(stack.indexOf(firstFound), stack.size()));
            stack.removeAll(elementsToRemove);
        }
    }